# Auto-generated by Baton

BERLIOZ_GROUP     := udacity
BERLIOZ_NAME      := study-hall
DOCKER_REPO       := $(BERLIOZ_GROUP)/$(BERLIOZ_NAME)
SERVICE_NAME      := $(BERLIOZ_NAME)
VERSION           ?= $(shell git rev-parse --short HEAD)
CONDUCTOR_APP_ID  := 2f0a177e-3e8b-11e8-9ac6-737d2e5ac4e9
export

.PHONY: all deploy docker deploy-staging deploy-preview

all: docker

docker:
	docker build -t $(SERVICE_NAME) .
	docker tag $(SERVICE_NAME) $(DOCKER_REPO):$(VERSION)
	docker push $(DOCKER_REPO)

_deploy:
	@curl --fail -X PUT "https://conductor-beta.udacity.com/api/v1/apps/$(CONDUCTOR_APP_ID)/deploy" \
		-H 'X-GitHub-Access-Token: $(CI_GITHUB_ACCESS_TOKEN)' \
		-d '{"environment": "$(ENVIRONMENT)", "image": "$(DOCKER_REPO):$(VERSION)"}'

deploy: ENVIRONMENT=production
deploy: docker
deploy: _deploy

deploy-staging: ENVIRONMENT=staging
deploy-staging: docker
deploy-staging: _deploy

deploy-preview: ENVIRONMENT=preview
deploy-preview: docker
deploy-preview: _deploy
